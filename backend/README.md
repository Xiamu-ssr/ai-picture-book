# README.md

> **AI Picture Book Backend**
> åŸºäº FastAPI + Diffusers çš„å¤šæ¡ä»¶ç»˜æœ¬ç”ŸæˆæœåŠ¡
> æ”¯æŒ **åŸå§‹åœºæ™¯å›¾ + å¤šè§’è‰²å½¢è±¡å›¾ + å¯é€‰è‰ç¨¿çº¿ç¨¿ + æ–‡æœ¬æç¤º** âœ ç”Ÿæˆä¸‹ä¸€å¹•è¿è´¯æ’ç”»

---

## ç›®å½•

1. [åŠŸèƒ½ç®€ä»‹](#åŠŸèƒ½ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [å¿«é€Ÿå¼€å§‹ï¼ˆConda ç¯å¢ƒï¼‰](#å¿«é€Ÿå¼€å§‹conda-ç¯å¢ƒ)
4. [æ¥å£æ–‡æ¡£](#æ¥å£æ–‡æ¡£)
5. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## åŠŸèƒ½ç®€ä»‹

| æ¨¡å—                      | ä½œç”¨                                     |
| ----------------------- | -------------------------------------- |
| **Stable Diffusion XL** | æ–‡æœ¬â†’å›¾åƒåŸºåº§ï¼Œç”Ÿæˆé«˜åˆ†è¾¨ç‡ç”»é¢                       |
| **IP-Adapter-FaceID**   | ä¿è¯è§’è‰²é¢éƒ¨&æœé¥°ä¸€è‡´                            |
| **IP-Adapter (Style)**  | ç»§æ‰¿ä¸Šä¸€å¹•çš„æ•´ä½“é£æ ¼ / å…‰å½±                        |
| **ControlNet (Depth)**  | è®©é•œå¤´é€è§†ã€å¸ƒå±€ä¸ä¸Šä¸€å¹•ä¿æŒè¿è´¯ï¼›åç»­å¯æ›¿æ¢ä¸º Pose / Lineart |

> ä¸€æ¬¡æ¨ç†å³å¯æ»¡è¶³ â€œé£æ ¼ä¸è·³ã€äººç‰©ä¸å˜ã€å§¿åŠ¿å¯æ§â€ã€‚

---

## é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€ app/
â”‚  â”œâ”€ main.py            # FastAPI å…¥å£
â”‚  â”œâ”€ schemas.py         # Pydantic è¯·æ±‚ / å“åº”
â”‚  â”œâ”€ model_loader.py    # SDXL + Adapter + ControlNet
â”‚  â”œâ”€ pipeline_utils.py  # å‰å¤„ç† / æ·±åº¦å›¾ / è¾“å…¥ç»„è£…
â”‚  â””â”€ image_utils.py     # base64 â†” PIL
â”œâ”€ requirements.txt
â””â”€ README.md             # å½“å‰æ–‡ä»¶
```

---

## å¿«é€Ÿå¼€å§‹ï¼ˆConda ç¯å¢ƒï¼‰

### 1. å‡†å¤‡ Conda

```bash
conda create -n aipb python=3.11
conda activate aipb
```

> * è‹¥ä½¿ç”¨ **CUDA**ï¼šè¯·æå‰å®‰è£…åŒ¹é…ç‰ˆæœ¬çš„ `pytorch` ä¸ `cudnn`
> * Apple Silicon å¯ç›´æ¥èµ° `torch==2.x` + `mps`ï¼Œä¸éœ€è¦ CUDA

### 2. å®‰è£…ä¾èµ–

```bash
# åç«¯ç›®å½•
cd backend
pip install -r requirements.txt
```

> é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä» Hugging Face æ‹‰å– SDXL / ControlNet / IP-Adapter æƒé‡
> å…¨é‡ä¸‹è½½ â‰ˆ 7 GBï¼Œè¯·ç¡®ä¿ç£ç›˜ä¸ç½‘ç»œå¯ç”¨ã€‚

### 3. å¯åŠ¨æœåŠ¡

```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

* æˆåŠŸæ—¥å¿—ç¤ºä¾‹

  ```
  ğŸª„ è½½å…¥ SDXL-base
  ğŸ¨ è½½å…¥ Style Adapter
  ğŸ˜€ è½½å…¥ FaceID Adapter
  âœ… æ¨¡å‹åŠ è½½å®Œæ¯•
  Application startup complete.
  ```

---

## æ¥å£æ–‡æ¡£

### POST `/generate`

| å­—æ®µ           | ç±»å‹         | å¿…å¡« | è¯´æ˜               |
| ------------ | ---------- | -- | ---------------- |
| `prev_frame` | base64 å­—ç¬¦ä¸² | âœ”  | ä¸Šä¸€å¹•å®Œæ•´åœºæ™¯ PNG/JPEG |
| `characters` | base64 æ•°ç»„  | âœ”  | N å¼ è§’è‰²å¤´åƒæˆ–åŠèº«åƒ      |
| `prompt`     | å­—ç¬¦ä¸²        | âœ”  | åœºæ™¯æè¿°ã€åŠ¨ä½œã€é•œå¤´è¯­è¨€     |
| `sketch`     | base64 å­—ç¬¦ä¸² | âœ–  | çº¿ç¨¿ / å§¿åŠ¿è‰å›¾ï¼ˆå¯é€‰ï¼‰    |
| `seed`       | æ•´æ•°         | âœ–  | éšæœºç§å­ï¼ˆå¤ç°ç”¨ï¼‰        |

#### ç¤ºä¾‹ (cURL)

```bash
curl -X POST http://localhost:8000/generate \
     -H "Content-Type: application/json" \
     -d '{
           "prev_frame":    "<base64-1>",
           "characters":    ["<face-1>", "<face-2>"],
           "prompt":        "é»„æ˜çš„å¤©æ¡¥ï¼ŒåŸå¸‚æ‹–å½±ï¼Œä¸¤ä½ä¸»è§’è¿ç€é€†å…‰ç‰µæ‰‹",
           "sketch":        null,
           "seed":          12345
         }'
```

æˆåŠŸå“åº”ï¼ˆç¤ºä¾‹ï¼‰

```json5
{
  "img": "<base64-output>"
}
```

> **è¾“å‡º**ä¸º PNG æ ¼å¼çš„ base64ï¼Œå¯ç›´æ¥å‰ç«¯ `<img src="data:image/png;base64, ...">` æ¸²æŸ“ã€‚

---

## å¸¸è§é—®é¢˜

| é—®é¢˜                | è§£å†³æ–¹æ¡ˆ                                                                                                                               |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| **æ˜¾å­˜ä¸è¶³ / CPU å¾ˆæ…¢** | å…ˆå°† `requirements.txt` ä¸­ `torch` æ›¿æ¢ä¸º CPU ç‰ˆï¼Œæˆ–åœ¨ä»£ç ä¸­å¯ç”¨ `pipe.enable_model_cpu_offload()`ï¼›Mac M1/2 å»ºè®®åŠ  `pipe.enable_attention_slicing()` |
| **ä¸‹è½½é€Ÿåº¦æ…¢**         | `huggingface-cli login` â†’ è®¾ç½®é•œåƒæºï¼ˆå¦‚æ¸…åé•œåƒï¼‰ï¼Œæˆ–æå‰æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹æ”¾å…¥ `~/.cache/huggingface`                                                          |
| **è§’è‰²èåˆ / è„¸å‹æ¼‚ç§»**   | ä¼ å…¥æ›´å¹²å‡€çš„ 224Ã—224 å¤´åƒï¼›å¿…è¦æ—¶é…åˆ `ip_adapter_masks` ä»…ä½œç”¨äºé¢éƒ¨åŒºåŸŸ                                                                                |
| **æƒ³æ¢å§¿åŠ¿æ§åˆ¶**        | å°† `pipeline_utils.make_depth()` æ›¿æ¢ä¸º OpenPose / Lineart å¤„ç†ï¼›ControlNet æƒé‡éœ€å¯¹åº”æ›´æ¢                                                       |

---

> æ¬¢è¿ Issue & PR æ”¹è¿›ï¼Œç¥åˆ›ä½œæ„‰å¿«ï¼
